{% extends 'main.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="user">
    <h2>Good Morning, {{ user.first_name }} {{ user.last_name}}! </h2>
    <p>Here‚Äôs how your dashboard looks like today!</p>
</div>
<div class="row">
    <div id="column">
        <div class="stats">
            <div id="total">

                <h1>üìä</h1>
            </div>
            <div id="hot">
                <p></p>
                <h1>üî•</h1>
            </div>
            <div id="med">
                <h1>üëç</h1>
            </div>
            <div id="gre">
                <h1>üëé</h1>
            </div>
        </div>
        <div class="graph">
            <h2 style="display: inline;">Lead Statistics</h2>
            <div>
                <select name="days" id="day">
                    <option value="Last 7 days">Last 7 days</option>
                    <option value="Last 15 days">Last 15 days</option>
                </select>
            </div>
            <div class="wrapper">
                <canvas id="myChart4"></canvas>
            </div>
        </div>
    </div>
    <div class="analytics-table">
        <table width="100%">
            <thead>
                <tr style="text-align: left;">
                    <th>Rank</th>
                    <th>Full Name</th>
                    <th>Leads Converted</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>
<script>
    var data;
    async function funcName(link) {
        newdata = []
        while (true) {
            const response = await fetch(link);
            data = await response.json();
            data.results.forEach(i => {
                newdata.push(i)
            })
            if (data.next == null)
                break;
            link = data.next
        }
        return newdata
    }

    async function dataFunc() {
        newdata = await funcName("http://127.0.0.1:8000/api/leads/");
        let arr = []
        newdata.forEach(lead => {
            let date = new Date(lead.created);
            date = date.toDateString()
            arr.push(date)

        })

        let obj = {}
        let j = 0;
        arr.forEach(i => {
            if (i in obj) {
                obj[i].push(newdata[j])
            }
            else
                obj[i] = [newdata[j]]
            j += 1;
        })

        hot = {}
        med = {}
        grey = {}

        for (let i in obj) {
            if (!(i in hot))
                hot[i] = 0
            obj[i].forEach(j => {
                if (j.state === "Hot Lead")
                    hot[i] += 1
            })
        }

        for (let i in obj) {
            if (!(i in med))
                med[i] = 0
            obj[i].forEach(j => {
                if (j.state === "Med Lead")
                    med[i] += 1
            })
        }

        for (let i in obj) {
            if (!(i in grey))
                grey[i] = 0
            obj[i].forEach(j => {
                if (j.state === "Grey Lead")
                    grey[i] += 1
            })
        }

        let data_list = [
            {
                label: 'Hot',
                backgroundColor: "#caf270",
                data: Object.values(hot),
            },
            {
                label: 'Med',
                backgroundColor: "#45c490",
                data: Object.values(med),
            },
            {
                label: 'Grey',
                backgroundColor: "#008d93",
                data: Object.values(grey),
            }
        ]

        var ctx = document.getElementById("myChart4").getContext('2d');

        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                // 
                labels: Object.keys(obj),
                datasets: data_list,
            },
            options: {
                tooltips: {
                    displayColors: true,
                    callbacks: {
                        mode: 'x',
                    },
                },
                scales: {
                    xAxes: [{
                        stacked: false,
                        gridLines: {
                            display: false,
                        }
                    }],
                    yAxes: [{
                        stacked: true,
                        ticks: {
                            beginAtZero: true,
                        },
                        type: 'linear',
                    }]
                },
                responsive: true,
                maintainAspectRatio: false,
                legend: { position: 'bottom' },
            }
        });
    }
    dataFunc();
</script>

{% endblock %}